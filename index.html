<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sadhana Tracker Level 4 - Final</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #6366f1; --accent: #f43f5e; --bg: #f8fafc; --card: #ffffff; }
        body { font-family: 'Outfit', sans-serif; background: var(--bg); margin: 0; padding: 15px; }
        .container { max-width: 900px; margin: 0 auto; }
        .card { background: var(--card); padding: 25px; border-radius: 16px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); margin-bottom: 20px; border: 1px solid #e2e8f0; }
        h2 { margin: 0 0 20px 0; color: #1e293b; font-size: 1.5rem; display: flex; align-items: center; gap: 10px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        label { display: block; font-weight: 600; margin-bottom: 8px; font-size: 0.85rem; color: #64748b; text-transform: uppercase; }
        input, select { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; transition: all 0.2s; font-size: 1rem; }
        input:focus, select:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1); }
        button { background: var(--primary); color: white; border: none; padding: 14px; border-radius: 10px; cursor: pointer; font-weight: 700; width: 100%; font-size: 1rem; transition: 0.3s; }
        button:hover { filter: brightness(1.1); transform: translateY(-1px); }
        .admin-section { border: 2px solid #6366f1; display: none; background: #eef2ff; }
        .report-table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 15px; }
        .report-table th { background: #6366f1; color: white; padding: 12px; text-align: left; font-size: 0.9rem; }
        .report-table td { padding: 12px; border-bottom: 1px solid #e2e8f0; background: white; }
        .hidden { display: none; }
        .badge { padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: bold; }
        .badge-l4 { background: #fee2e2; color: #ef4444; }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <h2>üë§ Devotee Profile</h2>
        <div class="grid">
            <div>
                <label>Full Name</label>
                <input type="text" id="p-name" placeholder="Enter Name">
            </div>
            <div>
                <label>Current Position</label>
                <select id="p-pos" onchange="handlePositionChange()">
                    <option value="Senior Batch">Senior Batch</option>
                    <option value="IGF Coordinator">IGF Coordinator</option>
                    <option value="Youth Overall Coordinator">Youth Overall Coordinator</option>
                </select>
            </div>
            <div>
                <label>Sadhana Level</label>
                <select id="p-level">
                    <option value="Level 1">Level 1 (Basic)</option>
                    <option value="Level 2">Level 2 (Active)</option>
                    <option value="Level 4">Level 4 (Strict / 16+)</option>
                </select>
            </div>
            <div>
                <label>Admin Key</label>
                <input type="password" id="admin-key" placeholder="For Reports">
            </div>
        </div>
        <button onclick="saveProfile()">Lock Profile & Sync</button>
    </div>

    <div class="card">
        <h2>üìù Daily Report</h2>
        <form id="sadhana-form">
            <div class="grid">
                <div><label>Date</label><input type="date" id="s-date" required></div>
                <div><label>Sleep (Target 10:30 PM)</label><input type="time" id="s-sleep" required></div>
                <div><label>Wakeup (Target 5:05 AM)</label><input type="time" id="s-wakeup" required></div>
                <div><label>Chanting Finished</label><input type="time" id="s-chanting" required></div>
            </div>
            <div class="grid">
                <div><label>Reading (Mins)</label><input type="number" id="s-read" value="0"></div>
                <div><label>Hearing (Mins)</label><input type="number" id="s-hear" value="0"></div>
                <div><label>Service (Mins)</label><input type="number" id="s-service" value="0"></div>
                <div id="notes-container" class="hidden"><label>Notes Rev (Mins)</label><input type="number" id="s-notes" value="0"></div>
            </div>
            <div class="grid">
                <div><label>Day Sleep (Mins)</label><input type="number" id="s-daysleep" value="0"></div>
            </div>
            <button type="submit">üöÄ Submit Today's Sadhana</button>
        </form>
    </div>

    <div id="admin-panel" class="card admin-section">
        <h2>üìä Efficiency Reports (Weekly)</h2>
        <div id="report-output"></div>
    </div>
</div>

<script>
    // FIREBASE SETUP
    const firebaseConfig = { /* PASTE YOUR ACTUAL CONFIG HERE */ };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let userData = JSON.parse(localStorage.getItem('user_meta')) || {};

    // TIME CONVERTER
    const t2m = (t, night = false) => {
        if(!t) return 0;
        let [h, m] = t.split(':').map(Number);
        let total = h * 60 + m;
        return night && h < 12 ? total + 1440 : total;
    };

    function handlePositionChange() {
        const pos = document.getElementById('p-pos').value;
        document.getElementById('notes-container').classList.toggle('hidden', pos !== "Senior Batch");
    }

    function saveProfile() {
        userData = {
            name: document.getElementById('p-name').value,
            pos: document.getElementById('p-pos').value,
            level: document.getElementById('p-level').value,
            isAdmin: document.getElementById('admin-key').value === "KRISHNA108"
        };
        localStorage.setItem('user_meta', JSON.stringify(userData));
        location.reload();
    }

    // SCORING ENGINE (LOCKED LOGIC)
    function calculateFinalScore(d) {
        let sc = { s:0, w:0, c:0, r:0, h:0, serv:0, n:0, ds:0 };

        // 1. Sleep: 5-min slabs from 10:30 PM (1350m)
        const sTime = t2m(d.sleep, true);
        if(sTime <= 1350) sc.s = 25;
        else if(sTime > 1380) sc.s = -5; // After 11:00 PM
        else sc.s = 25 - (Math.ceil((sTime - 1350) / 5) * 5);

        // 2. Wakeup: 5-min slabs from 5:05 AM (305m)
        const wTime = t2m(d.wakeup);
        if(wTime <= 305) sc.w = 25;
        else if(wTime > 335) sc.w = -5; // After 5:35 AM
        else sc.w = 25 - (Math.ceil((wTime - 305) / 5) * 5);

        // 3. Chanting Buckets (The logic you corrected)
        const cTime = t2m(d.chanting);
        if(cTime <= 540) sc.c = 25; // 9 AM
        else if(cTime <= 570) sc.c = 20; // 9:30 AM
        else if(cTime <= 660) sc.c = 15; // 11 AM
        else if(cTime <= 870) sc.c = 10; // 2:30 PM
        else if(cTime <= 1020) sc.c = 5;  // 5 PM
        else if(cTime <= 1140) sc.c = 0;  // 7 PM
        else sc.c = -5;

        // 4. Study Slabs
        const studyPts = (m) => (m >= 30 ? 25 : (m >= 15 ? 15 : (m >= 10 ? 5 : 0)));
        if(userData.level === "Level 4") {
            sc.r = studyPts(d.read);
            sc.h = studyPts(d.hear);
        } else {
            sc.r = Math.max(studyPts(d.read), studyPts(d.hear));
        }

        // 5. Position Based (LOCKED)
        if(userData.pos === "Senior Batch") {
            sc.serv = d.service >= 15 ? 10 : 0; // Senior: 15m = 10pts
            sc.n = d.notes >= 20 ? 15 : 0;      // Senior: 20m = 15pts
        } else {
            sc.serv = d.service >= 30 ? 25 : (d.service >= 15 ? 15 : (d.service >= 5 ? 5 : 0));
        }

        // 6. Day Sleep
        sc.ds = d.daySleep === 0 ? 10 : (d.daySleep <= 60 ? 5 : -5);

        return Object.values(sc).reduce((a,b)=>a+b, 0);
    }

    // SUBMIT DATA
    document.getElementById('sadhana-form').onsubmit = async (e) => {
        e.preventDefault();
        const d = {
            sleep: document.getElementById('s-sleep').value,
            wakeup: document.getElementById('s-wakeup').value,
            chanting: document.getElementById('s-chanting').value,
            read: parseInt(document.getElementById('s-read').value),
            hear: parseInt(document.getElementById('s-hear').value),
            service: parseInt(document.getElementById('s-service').value),
            notes: parseInt(document.getElementById('s-notes').value),
            daySleep: parseInt(document.getElementById('s-daysleep').value),
            date: document.getElementById('s-date').value
        };

        const total = calculateFinalScore(d);
        await db.collection('sadhana_logs').add({
            ...d, score: total, uName: userData.name, uLevel: userData.level, 
            uPos: userData.pos, createdAt: new Date()
        });
        alert(`Sadhana Saved! Daily Score: ${total}/160`);
    };

    // LOAD REPORTS (ADMIN)
    async function loadReports() {
        const snap = await db.collection('sadhana_logs').get();
        let aggregation = {};

        snap.forEach(doc => {
            const log = doc.data();
            if(!aggregation[log.uName]) aggregation[log.uName] = { score: 0, level: log.uLevel };
            aggregation[log.uName].score += log.score;
        });

        let html = `<table class="report-table"><tr><th>Devotee</th><th>Level</th><th>Weekly Eff. %</th></tr>`;
        for(let name in aggregation) {
            const max = aggregation[name].level === "Level 4" ? 1120 : 770;
            const eff = ((aggregation[name].score / max) * 100).toFixed(1);
            html += `<tr><td>${name}</td><td><span class="badge badge-l4">${aggregation[name].level}</span></td><td><b>${eff}%</b></td></tr>`;
        }
        document.getElementById('report-output').innerHTML = html + `</table>`;
    }

    window.onload = () => {
        if(userData.name) {
            document.getElementById('p-name').value = userData.name;
            document.getElementById('p-pos').value = userData.pos;
            document.getElementById('p-level').value = userData.level;
            handlePositionChange();
            if(userData.isAdmin) {
                document.getElementById('admin-panel').style.display = 'block';
                loadReports();
            }
        }
    };
</script>
</body>
</html>
